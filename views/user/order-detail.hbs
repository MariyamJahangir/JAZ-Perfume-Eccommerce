{{>header}}
<style>
    .nav-item:hover {
        background-color: #DFF2FA;
        /* Light blue background on hover */
        cursor: pointer;
        /* Add a pointer cursor for better UX */
    }

    .nav-item.active {
        background-color: #DFF2FA;
        /* Fixed light blue background for active */
    }

    .bg-theme{
        background-color: #DFF2FA;
    }
</style>

<section style="background-color: #DFF2FA;">
    <div class="container">
        <div class="row p-5">
            <h2>Welcome Mariyam Jahangir</h2>
        </div>

    </div>
</section>
<section>
    <div class="container">
        <div class="row">
            <div class="col-2 mt-5">
                <nav class="d-flex flex-column p-3">
                    <a href="/profile" class="link-dark link-underline-opacity-0 nav-item rounded px-3 py-2 mb-2"><i
                            class="bi bi-person-circle p-2"></i>Profile</a>
                    <a href="/address" class="link-dark link-underline-opacity-0 nav-item rounded px-3 py-2 mb-2"><i
                            class="bi bi-cart4 p-2"></i>Address</a>
                    <a href="/wishlist" class="link-dark link-underline-opacity-0 nav-item rounded px-3 py-2 mb-2"><i
                            class="bi bi-heart p-2"></i>Wishlist</a>
                    <a href="/../orders"
                        class="link-dark link-underline-opacity-0 nav-item rounded px-3 py-2 mb-2 active"
                        aria-current="page"><i class="bi bi-truck p-2"></i>Orders</a>
                    <a href="/change-password"
                        class="link-dark link-underline-opacity-0 nav-item rounded px-3 py-2 mb-2"><i
                            class="bi bi-key p-2"></i>Password</a>
                    <a href="/wallet" class="link-dark link-underline-opacity-0 nav-item rounded px-3 py-2 mb-2"><i
                            class="bi bi-wallet2 p-2"></i>Wallet</a>
                    <a href="/logout" class="link-dark link-underline-opacity-0 nav-item rounded px-3 py-2 mb-2"><i
                            class="bi bi-box-arrow-right p-2"></i>Logout</a>
                </nav>
            </div>


            <div class="col-10">
                <div class="container m-4 p-4 border bg-theme">
                    <h1 class="text-center pb-4">ORDER DETAILS</h1>



                    {{#each order.items}}
                    <div class="grid gap-1 d-flex justify-content-between p-3">
                        <!-- Product Image -->
                        <div class="col-3 text-center p-2">
                            <a href="/product-details/{{this.productId._id}}/{{this.variantId}}"><img
                                    src="/uploads/{{this.productId.images.[0]}}" alt="{{this.productId.name}}"
                                    style="width: 60%"></a>
                        </div>

                        <!-- Product Details -->
                        <div class="col-5 d-flex align-items-center">
                            <div>
                                <p><a href="/product-details/{{this.productId._id}}/{{this.variantId}}"
                                        class="text-decoration-none link-dark">{{this.productId.name}}</a> -
                                    {{getVariantQuantity this.productId.variant this.variantId}} ML</p>

                                <p>Quantity: {{this.quantityCount}}</p>
                                <p>Price: Rs. {{this.price}}</p>
                                {{#if (or (isEqual this.status "Delivered") (isEqual this.status "Returned"))}}
                                <p>Delivered on: {{formatDate this.deliveredDate}}</p>{{/if}}
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="ps-4 col-4 d-flex flex-column justify-content-center">


                            <div class="p-2">
                                {{#if (isEqual this.status "Pending")}}
                                <span class="badge text-bg-primary">Pending</span>
                                {{else if (isEqual this.status "Delivered")}}
                                <span class="badge text-bg-success">Delivered</span>
                                {{else if (isEqual this.status "Returned")}}
                                <span class="badge text-bg-secondary">Returned</span>
                                {{else if (isEqual this.status "Shipped")}}
                                <span class="badge text-bg-info">Shipped</span>
                                {{else if (isEqual this.status "Cancelled")}}
                                <span class="badge text-bg-danger">Cancelled</span>
                                {{else}}
                                <span class="badge text-bg-warning">{{this.status}}</span>
                                {{/if}}
                            </div>

                            <div class="p-2">
                                {{#if (isEqual this.status "Delivered")}}
                                <!-- Return Button with Confirmation -->
                                <form id="returnForm-{{../order._id}}-{{this.productId._id}}"
                                    action="/order/return/{{../order._id}}/{{this.productId._id}}" method="POST">
                                    <button type="button" class="btn btn-outline-primary px-3"
                                        onclick="confirmAction('return', '{{../order._id}}', '{{this.productId._id}}', '{{this.status}}')"
                                        {{#if (isReturnEligible this.deliveredDate)}}disabled{{/if}}>
                                        Return
                                    </button>
                                </form>
                                {{else}}
                                <!-- Cancel Button with Confirmation -->
                                <form id="cancelForm-{{../order._id}}-{{this.productId._id}}"
                                    action="/order/cancel/{{../order._id}}/{{this.productId._id}}/{{this.variantId}}"
                                    method="POST">
                                    <button type="button" class="btn btn-outline-danger px-3"
                                        onclick="confirmAction('cancel', '{{../order._id}}', '{{this.productId._id}}', '{{this.status}}')"
                                        {{#if (or (or (isEqual this.status "Cancelled" ) (isEqual this.status "Returned" )) (isEqual this.status "Return Approved" ))}}hidden{{/if}}>
                                        Cancel
                                    </button>

                                </form>
                                {{/if}}
                            </div>

                            <div class="p-2">
                                {{#if (isReturnEligible this.deliveredDate)}}
                                <button type="button" class="btn btn-outline-primary">Rate this Product</button>
                                {{/if}}
                            </div>

                        </div>
                    </div>
                    <hr>
                    {{/each}}

                    <!-- Delivery Address -->
                    <div class="grid gap-1 d-flex justify-content-between p-3 border border-2">
                        <div class="col-7 ps-3">

                            <p class="fw-bold">Shipping Address</p>
                            <p><span>{{order.shippingAddress.firstname}} {{order.shippingAddress.lastname}}</span>
                                <span>{{order.shippingAddress.phone}}</span>
                            </p>
                            <span>{{order.shippingAddress.address}}, {{order.shippingAddress.locality}},
                                {{order.shippingAddress.district}}, {{order.shippingAddress.state}} -
                                {{order.shippingAddress.pincode}}</span>
                        </div>
                        <div class="col-5 ps-3">
                            <p>Total Amount: {{order.totalAmount}}</p>
                            <p>Order ID: {{order.orderId}}</p>
                            <span>Ordered On: {{formatDate order.orderDate}}</span>
                        </div>

                    </div>
                </div>
            </div>

        </div>
    </div>
</section>

<!-- Return Reason Modal -->
<div class="modal fade" id="returnModal" tabindex="-1" aria-labelledby="returnModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="returnModalLabel">Select Return Reason</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="returnForm">
                    <input type="hidden" id="returnOrderId">
                    <input type="hidden" id="returnProductId">

                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="returnReason" value="Defective product" id="reason1">
                        <label class="form-check-label" for="reason1">Defective product</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="returnReason" value="Received wrong item" id="reason2">
                        <label class="form-check-label" for="reason2">Received wrong item</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="returnReason" value="Not as described" id="reason3">
                        <label class="form-check-label" for="reason3">Not as described</label>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Confirm Return</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<!-- Cancel Reason Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cancelModalLabel">Select Cancellation Reason</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="cancelForm" method="POST">
                    <input type="hidden" name="orderId" id="orderId">
                    <input type="hidden" name="productId" id="productId">
                    <div>
                        <label><input type="radio" name="cancelReason" value="Order by mistake"> Order by mistake
                        </label><br>
                        <label><input type="radio" name="cancelReason" value="Found a better price"> Found a better
                            price </label><br>
                        <label><input type="radio" name="cancelReason" value="Delivery taking too long"> Delivery taking
                            too long </label><br>

                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="submit" form="cancelForm" class="btn btn-danger">Confirm Cancellation</button>
            </div>
        </div>
    </div>
</div>



{{>footer}}


<!-- JavaScript for Confirmation -->
<script>
    function confirmAction(action, orderId, productId, status) {
        const formId = action === 'return' ? `returnForm-${orderId}-${productId}` : `cancelForm-${orderId}-${productId}`;

        let text = "";

        if (action === 'return') {
            text = "Do you really want to return this product?";
        } else {
            if (status === "Returned") {
                text = "Do you really want to cancel this return?";
            } else {
                text = "Do you really want to cancel this order?";
            }
        }

        Swal.fire({
            title: "Are you sure?",
            text: text,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, proceed!'
        }).then((result) => {
            if (result.isConfirmed) {
                if (action === 'cancel') {
                    // Open the cancel reason modal only if "Yes, proceed!" is clicked
                    document.getElementById("orderId").value = orderId;
                    document.getElementById("productId").value = productId;
                    var cancelModal = new bootstrap.Modal(document.getElementById('cancelModal'));
                    cancelModal.show();
                } else if (action === 'return') {
                    // Open the return reason modal
                    document.getElementById("returnOrderId").value = orderId;
                    document.getElementById("returnProductId").value = productId;
                    var returnModal = new bootstrap.Modal(document.getElementById('returnModal'));
                    returnModal.show();
                }
            }
        });
    }

    // Ensure the return form submission happens only after selecting a reason
    document.getElementById("returnForm").addEventListener("submit", function (e) {
        e.preventDefault(); // Prevent default submission until reason is confirmed

        const selectedReason = document.querySelector('input[name="returnReason"]:checked');
        if (!selectedReason) {
            Swal.fire("Error", "Please select a reason for returning the product.", "error");
            return;
        }

        // Append the selected reason to the form
        const orderId = document.getElementById("returnOrderId").value;
        const productId = document.getElementById("returnProductId").value;
        const formId = `returnForm-${orderId}-${productId}`;
        const returnForm = document.getElementById(formId);

        const reasonInput = document.createElement("input");
        reasonInput.type = "hidden";
        reasonInput.name = "returnReason";
        reasonInput.value = selectedReason.value;
        returnForm.appendChild(reasonInput);

        // Submit the form
        returnForm.submit();
    });


    // Ensure the cancel form submission happens only after selecting a reason
    document.getElementById("cancelForm").addEventListener("submit", function (e) {
        e.preventDefault(); // Prevent default submission until we confirm the reason

        const selectedReason = document.querySelector('input[name="cancelReason"]:checked');
        if (!selectedReason) {
            Swal.fire("Error", "Please select a reason for cancellation.", "error");
            return;
        }

        // Append the selected reason to the form
        const orderId = document.getElementById("orderId").value;
        const productId = document.getElementById("productId").value;
        const formId = `cancelForm-${orderId}-${productId}`;
        const cancelForm = document.getElementById(formId);

        const reasonInput = document.createElement("input");
        reasonInput.type = "hidden";
        reasonInput.name = "cancelReason";
        reasonInput.value = selectedReason.value;
        cancelForm.appendChild(reasonInput);

        // Submit the form after confirmation
        cancelForm.submit();
    });



</script>