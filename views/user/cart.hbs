{{>header}}




<section>
    <div class="container">
        <div class="row p-5">
            <div class="col-8">
                <div class="py-4">
                    <h2>Your Cart</h2>
                </div>

                {{#if cartItems.length}}
                {{#each cartItems}}
                <div class="row d-flex justify-content-between border p-2 me-3">
                    <div class="col-2">
                        <img src="/uploads/{{this.products.images.[0]}}" alt="" style="width: 70%;">
                    </div>
                    <div class="col-5 align-content-center">
                        <p><a href="/user/product-details/{{this.products._id}}"
                                class="fw-bold text-black link-underline link-underline-opacity-0">{{this.products.name}}</a>
                        </p>
                        <span>Variant: {{this.selectedVariant.quantityML}}ML</span>
                    </div>
                    <div class="col-2 align-content-center">
                        <p class="mb-0">₹{{this.totalPrice}}</p>
                    </div>
                    <div class="col-3 align-content-center">
                        <button class="btn btn-sm btn-outline-secondary rounded-circle me-1"
                            onclick="decreaseQuantity('{{this._id}}')">-</button>
                        <span class="quantity">{{this.quantityCount}}</span>
                        <button class="btn btn-sm btn-outline-secondary rounded-circle ms-1"
                            onclick="increaseQuantity('{{this._id}}')">+</button>
                        <button class="btn btn-sm btn-danger ms-3" onclick="removeProduct('{{this._id}}')">X</button>
                    </div>
                </div>
                {{/each}}
                {{else}}
                <div class="text-center p-5">
                    <h3>Your cart is empty!</h3>
                    <a href="/user/all-products" class="btn btn-dark mt-3 px-3">Shop Now</a>
                </div>
                {{/if}}

            </div>

            <div class="col-4 border bg-light mt-5">
                <div class="p-3">
                    <h4>Order Summary</h4>
                </div>
                <div class="p-3 text-center">
                    <div class="d-flex justify-content-between py-2"><span>Subtotal:</span><span>₹{{totalPrice}}</span>
                    </div>
                    <div class="d-flex justify-content-between py-2"><span>Discount</span><span>-₹0</span></div>
                    <div class="d-flex justify-content-between py-2"><span>Shipping:</span><span>Free</span></div>
                    <hr>
                    <div class="d-flex justify-content-between py-2"><span>Total:</span><span>₹{{totalPrice}}</span>
                    </div>
                    {{!-- <a href="/user/checkout" class="btn btn-dark w-100 my-2">Checkout</a> --}}
                    <!-- Checkout Button -->
                    <button id="checkoutButton" class="btn btn-dark w-100 my-2">Checkout</button>
                    <a href="/user/home" class="btn btn-link link-dark my-2">Continue Shopping..</a>
                </div>
            </div>

        </div>

    </div>
</section>


{{>footer}}

<script>
    // Checkout Button Functionality
    document.getElementById('checkoutButton').addEventListener('click', function (event) {
        // Check if the cart is empty before navigating to checkout
        if (!{{ cartItems.length }}) {
            event.preventDefault();  // Prevent navigation to the checkout page
            Swal.fire({
                icon: 'warning',
                title: 'Your Cart is Empty!',
                text: 'Please add items to your cart before proceeding to checkout.',
                confirmButtonText: 'OK',
                confirmButtonColor: '#3085d6'
            });
        }else {
            // Cart has items: redirect to checkout page
            window.location.href = "/user/checkout";
        }
    });

    async function increaseQuantity(cartItemId) {
        try {
            const response = await fetch(`/user/cart/increase/${cartItemId}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" }
            });

            const data = await response.json();
            if (data.success) {
                location.reload(); // Refresh page to update cart UI
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Failed to Update Quantity',
                    text: 'Please try again later.',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#d33'
                });
            }
        } catch (error) {
            console.error("Error updating quantity:", error);
        }
    }

    async function decreaseQuantity(cartItemId) {
        try {
            const response = await fetch(`/user/cart/decrease/${cartItemId}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" }
            });

            const data = await response.json();
            if (data.success) {
                location.reload(); // Refresh page to reflect updated values
            } else {
                Swal.fire({
                    icon: 'error', 
                    title: 'Oops!',
                    text: data.message,
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#d33'
                }); // Show alert if quantity can't be reduced further
            }
        } catch (error) {
            console.error("Error decreasing quantity:", error);
        }
    }

    async function removeProduct(cartItemId) {
         const result = await Swal.fire({
            title: 'Are you sure?',
            text: "Do you want to remove this item from your cart?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, remove it!',
            cancelButtonText: 'Cancel'
        });

        if (!result.isConfirmed) {
            return; // If user cancels, do nothing
        }
        
        try {
            const response = await fetch(`/user/cart/remove/${cartItemId}`, {
                method: "DELETE",
                headers: { "Content-Type": "application/json" }
            });

            const data = await response.json();
            if (data.success) {
                location.reload(); // Reload page after successful deletion
            } else {
                Swal.fire({
                    icon: 'error', 
                    title: 'Oops!',
                    text: data.message,
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#d33'
                });
            }
        } catch (error) {
            console.error("Error removing product:", error);
        }
    }



</script>