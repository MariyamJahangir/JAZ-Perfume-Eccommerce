<link rel="stylesheet" href="/styles/admin.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.js"
    integrity="sha512-7DgGWBKHddtgZ9Cgu8aGfJXvgcVv4SWSESomRtghob4k4orCBUTSRQ4s5SaC2Rz+OptMqNk0aHHsaUBk6fzIXw=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<section class="bgcolor">
    <div class="row">

        {{!-- Sidebar --}}
        <div class="aside col-md-2">
            <div class="d-flex justify-content-evenly align-items-center">
                <div>
                    <img src="/images/JAZPERFUME.png" alt="" class="logo_image">
                    <p class="fs-6">PERFUMES</p>
                </div>
                <p class="fs-3 fw-2">ADMIN</p>
            </div>

            <div class="nav flex-column px-3">
                <a href="#" class="nav-link active" aria-current="page">
                    <span class="nav-icon">
                        <img src="https://cdn.builder.io/api/v1/image/assets/TEMP/f82b0047e6557aa901c15537d58a7ab6971e1d1d635e2a205c02ec234f11ad61?placeholderIfAbsent=true&apiKey=a98241ab2d584afe817596fb423a2646"
                            alt="Dashboard" loading="lazy">
                    </span>
                    <span class="nav-text">Dashboard</span>
                </a>

                <a href="products" class="nav-link">
                    <span class="nav-icon">
                        <img src="https://cdn.builder.io/api/v1/image/assets/TEMP/126b232c82239fc3740982b7c8240f84671d1b6e2a4d00141995b3c82d24c4a5?placeholderIfAbsent=true&apiKey=a98241ab2d584afe817596fb423a2646"
                            alt="Products" loading="lazy">
                    </span>
                    <span class="nav-text">Products</span>
                </a>

                <a href="category" class="nav-link">
                    <span class="nav-icon">
                        <img src="https://cdn.builder.io/api/v1/image/assets/TEMP/c46200642d44aab62899b16a25fc8bfe94e9df6fede3e3512b370b3d4f514356?placeholderIfAbsent=true&apiKey=a98241ab2d584afe817596fb423a2646"
                            alt="Categories" loading="lazy">
                    </span>
                    <span class="nav-text">Categories</span>
                </a>

                <a href="orders" class="nav-link">
                    <span class="nav-icon">
                        <img src="https://cdn.builder.io/api/v1/image/assets/TEMP/395e632ba7027a03ce2c35c1aa8bcc4534da249d8c136cdcc01b5043a72ddc87?placeholderIfAbsent=true&apiKey=a98241ab2d584afe817596fb423a2646"
                            alt="Orders" loading="lazy">
                    </span>
                    <span class="nav-text">Orders</span>
                </a>

                <a href="customers" class="nav-link">
                    <span class="nav-icon">
                        <img src="https://cdn.builder.io/api/v1/image/assets/TEMP/f933064a6bab49b74f8d5722595a056cbddbca1247d9b1a20a7e0fc8d56413a0?placeholderIfAbsent=true&apiKey=a98241ab2d584afe817596fb423a2646"
                            alt="Customers" loading="lazy">
                    </span>
                    <span class="nav-text">Customers</span>
                </a>

                <a href="offers" class="nav-link">
                    <span class="nav-icon">
                        <img src="https://cdn.builder.io/api/v1/image/assets/TEMP/ba76937fe489134f0c577be82a18baeadddda8f77194bbcb94734c6db29400c0?placeholderIfAbsent=true&apiKey=a98241ab2d584afe817596fb423a2646"
                            alt="Offers" loading="lazy">
                    </span>
                    <span class="nav-text">Offers</span>
                </a>

                <a href="coupons" class="nav-link">
                    <span class="nav-icon">
                        <img src="https://cdn.builder.io/api/v1/image/assets/TEMP/cabe95d2f5fab42e35aad96d91245b122dd4d50ddfe8d1d2bceee5ea219442d8?placeholderIfAbsent=true&apiKey=a98241ab2d584afe817596fb423a2646"
                            alt="Coupons" loading="lazy">
                    </span>
                    <span class="nav-text">Coupons</span>
                </a>

                <a href="#" class="nav-link">
                    <span class="nav-icon">
                        <img src="https://cdn.builder.io/api/v1/image/assets/TEMP/2897cc0ce7ace4dd1f7e6d2c1b779540e7fa6d14150e07ac6bd13caecdf99b1a?placeholderIfAbsent=true&apiKey=a98241ab2d584afe817596fb423a2646"
                            alt="Reviews" loading="lazy">
                    </span>
                    <span class="nav-text">Reviews</span>
                </a>

                <a href="#" class="nav-link">
                    <span class="nav-icon">
                        <img src="https://cdn.builder.io/api/v1/image/assets/TEMP/5b4c30ca0a115c712594c2dce59791803bec209977f960ad8b2c1a3d2ecaac23?placeholderIfAbsent=true&apiKey=a98241ab2d584afe817596fb423a2646"
                            alt="Settings" loading="lazy">
                    </span>
                    <span class="nav-text">Settings</span>
                </a>
            </div>
        </div>


        {{!-- Content Section --}}
        <div class="col-md-10">

            {{!-- Breadcrumps --}}
            <div class="row px-2 pt-2">
                <div class="col-10">
                    <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="#" class="link-dark link-underline-opacity-0">Admin</a>
                            </li>
                            <li class="breadcrumb-item active text-dark" aria-current="page">Dashboard</li>
                        </ol>
                    </nav>
                </div>
                <div class="col-2">
                    <button type="button" class="btn btn-outline-dark btn-sm"
                        onclick="window.location.href='/admin/logout'">Logout<i
                            class="bi bi-box-arrow-right ps-2"></i></button>

                </div>
            </div>

            {{!-- First data section --}}
            <div class="row d-flex justify-content-around">

                <!-- Bar Chart (Total Sales) -->
                <div class="containerbox col-md-10 mx-0" style="width: 90%;">
                    <div class="row d-flex justify-content-between align-items-center">
                        
                        <div class="col-md-3 ps-4">
                            <h5>Total Sales</h5>
                            <p style="font-size: small;">THIS MONTH</p>
                        </div>
                        
                        <div class="col-md-3 align-self-center">
                            <p class="fs-4 text-center">Rs.{{toFixed lastMonthlySales 2}}</p>
                        </div>

                        <div class="col-md-3 text-center" >
                            <a href="/admin/sales-report" class="btn btn-warning">View Report</a>
                        </div>
                    </div>
                    <div class="row">
                        <div class="chart-container">
                            <canvas id="barchart"></canvas>
                        </div>
                    </div>
                </div>

            </div>

            <div class="row d-flex justify-content-around p-4">
                <!-- Progress (Orders) -->
                <div class="containerbox col-md-4 m-0">
                    <div class="row">
                        <a href="/admin/sales-report" style="text-decoration:none; color:black;">
                            <div class="col-md-6 ps-4">
                                <h5>Orders</h5>
                                <p style="font-size: small;">Monthly Goals: 100</p>
                            </div>
                            <div class="col-md-6 align-self-center">
                                <!-- Order count display -->
                            </div>
                        </a>
                    </div>
                    <div class="row">
                        <div class="col-md-12 ps-4 ">
                            <div class="orderprogress mt-5">
                                <p>{{sub 100 lastMonthlyOrders}} left</p>
                                <div class="progress" role="progressbar" aria-label="Example 15px high"
                                    aria-valuemin="0" aria-valuemax="100" style="height: 15px">
                                    <div class="progress-bar"
                                        style="width: {{multiply (divide lastMonthlyOrders 10) 100}}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>



                <div class="containerbox col-md-4 m-0" style="width: 60%;">
                    <div class="row">
                        <a href="/admin/sales-report" style="text-decoration:none; color:black;">
                            <div class="col-md-6 ps-4">
                                <h5>Customers</h5>
                                <p style="font-size: small;">THIS MONTH</p>
                            </div>
                            <div class="col-md-6 align-self-center">
                                <p class="fs-4 text-center">{{lastMonthlyCustomers}}</p>
                            </div>
                        </a>
                    </div>
                    <div class="row">
                        <div class="chart-container">
                            <canvas id="linechart"></canvas>
                        </div>
                    </div>
                </div>
            </div>



            <div class="row d-flex justify-content-around">
                <!-- Second row with category pie chart and top selling products -->
                
                    <!-- Category Pie Chart -->
                    <div class="col-md-6">
                        <div class="containerbox">
                            <h5 class="mb-3 ps-2">Category Distribution</h5>
                            <div class="category-chart-container">
                                <canvas id="categoryPieChart"></canvas>
                            </div>
                        </div>
                    </div>



            </div>


        </div>


</section>


<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const monthlySalesLabels = JSON.parse('{{{monthlySalesLabels}}}');
        const monthlySalesData = JSON.parse('{{{monthlySalesData}}}');

        const backgroundColors = monthlySalesLabels.map((_, i) =>
            `hsl(${(i * 360 / monthlySalesLabels.length)}, 70%, 60%)`
        );

        const salesData = {
            labels: monthlySalesLabels,
            datasets: [{
                label: "Total Sales (â‚¹)",
                backgroundColor: backgroundColors,
                borderColor: "#333",
                borderWidth: 1,
                hoverBackgroundColor: "#8593cc",
                data: monthlySalesData
            }]
        };

        new Chart(document.getElementById("barchart"), {
            type: 'bar',
            data: salesData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        labels: {
                            font: {
                                size: 14,
                                family: "'Segoe UI', sans-serif"
                            },
                            color: "#000"
                        }
                    },
                    tooltip: {
                        backgroundColor: "#222",
                        titleColor: "#fff",
                        bodyColor: "#fff",
                        borderColor: "#ccc",
                        borderWidth: 1
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: "#333",
                            font: { size: 12 }
                        }
                    },
                    x: {
                        ticks: {
                            color: "#333",
                            font: { size: 12 }
                        },
                        grid: { display: false }
                    }
                }
            }
        });


        const ctx = document.getElementById('linechart').getContext('2d');


        const monthlyCustomersData = JSON.parse('{{{monthlyCustomersData}}}');


        const currentDate = new Date();
        const currentMonth = currentDate.getMonth();


        const monthLabels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];


        let chartLabels = [];
        for (let i = 11; i >= 0; i--) {

            let monthIndex = (currentMonth - i + 12) % 12;
            chartLabels.push(monthLabels[monthIndex]);
        }


        chartLabels = chartLabels.slice(12 - monthlyCustomersData.length);


        const customerChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: 'Monthly New Customers',
                    data: monthlyCustomersData,
                    fill: false,
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    tension: 0.1,
                    pointBackgroundColor: 'rgb(54, 162, 235)',
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.7)',
                        titleFont: {
                            size: 14,
                            weight: 'bold'
                        },
                        bodyFont: {
                            size: 13
                        },
                        callbacks: {
                            title: function (tooltipItems) {
                                return tooltipItems[0].label;
                            },
                            label: function (context) {
                                return 'New Customers: ' + context.raw;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        ticks: {
                            precision: 0
                        },
                        title: {
                            display: true,
                            text: 'Number of New Customers',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Month',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        }
                    }
                }
            }
        });


        var categoryData = {
            labels: [
                {{#each topSellingCategories}}
                '{{this.categoryName}}',
                    {{/each}}
            ],
            datasets: [{
                data: [
                    {{#each topSellingCategories }}
                    {{ this.totalSold }},
                    {{/each}}
                ],
                backgroundColor: [
                    'rgba(255, 99, 132, 0.7)',
                    'rgba(54, 162, 235, 0.7)',
                    'rgba(255, 206, 86, 0.7)',
                    'rgba(75, 192, 192, 0.7)',
                    'rgba(153, 102, 255, 0.7)',
                    'rgba(255, 159, 64, 0.7)',
                    'rgba(199, 199, 199, 0.7)'
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)',
                    'rgba(199, 199, 199, 1)'
                ],
                borderWidth: 1
            }]
        };

        new Chart(document.getElementById("categoryPieChart"), {
            type: 'pie',
            data: categoryData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            boxWidth: 15,
                            padding: 15
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                var label = context.label || '';
                                var value = context.raw || 0;
                                var total = context.dataset.data.reduce((a, b) => a + b, 0);
                                var percentage = Math.round((value / total) * 100);
                                return label + ': ' + value + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });

    });
</script>