<link rel="stylesheet" href="/styles/admin.css">
{{!--
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.js"
  integrity="sha512-7DgGWBKHddtgZ9Cgu8aGfJXvgcVv4SWSESomRtghob4k4orCBUTSRQ4s5SaC2Rz+OptMqNk0aHHsaUBk6fzIXw=="
  crossorigin="anonymous" referrerpolicy="no-referrer"></script> --}}




<section class="bgcolor">
  <div class="row">

    {{!-- Sidebar --}}
    <div class="aside col-md-2">
      <div class="d-flex justify-content-evenly align-items-center">
        <div>
          <img src="/images/JAZPERFUME.png" alt="" class="logo_image">
          <p class="fs-6">PERFUMES</p>
        </div>
        <p class="fs-3 fw-2">ADMIN</p>
      </div>

      <div class="nav flex-column px-3">
        <a href="#" class="nav-link active" aria-current="page">
          <span class="nav-icon">
            <img
              src="https://cdn.builder.io/api/v1/image/assets/TEMP/f82b0047e6557aa901c15537d58a7ab6971e1d1d635e2a205c02ec234f11ad61?placeholderIfAbsent=true&apiKey=a98241ab2d584afe817596fb423a2646"
              alt="Dashboard" loading="lazy">
          </span>
          <span class="nav-text">Dashboard</span>
        </a>

        <a href="products" class="nav-link">
          <span class="nav-icon">
            <img
              src="https://cdn.builder.io/api/v1/image/assets/TEMP/126b232c82239fc3740982b7c8240f84671d1b6e2a4d00141995b3c82d24c4a5?placeholderIfAbsent=true&apiKey=a98241ab2d584afe817596fb423a2646"
              alt="Products" loading="lazy">
          </span>
          <span class="nav-text">Products</span>
        </a>

        <a href="category" class="nav-link">
          <span class="nav-icon">
            <img
              src="https://cdn.builder.io/api/v1/image/assets/TEMP/c46200642d44aab62899b16a25fc8bfe94e9df6fede3e3512b370b3d4f514356?placeholderIfAbsent=true&apiKey=a98241ab2d584afe817596fb423a2646"
              alt="Categories" loading="lazy">
          </span>
          <span class="nav-text">Categories</span>
        </a>

        <a href="orders" class="nav-link">
          <span class="nav-icon">
            <img
              src="https://cdn.builder.io/api/v1/image/assets/TEMP/395e632ba7027a03ce2c35c1aa8bcc4534da249d8c136cdcc01b5043a72ddc87?placeholderIfAbsent=true&apiKey=a98241ab2d584afe817596fb423a2646"
              alt="Orders" loading="lazy">
          </span>
          <span class="nav-text">Orders</span>
        </a>

        <a href="customers" class="nav-link">
          <span class="nav-icon">
            <img
              src="https://cdn.builder.io/api/v1/image/assets/TEMP/f933064a6bab49b74f8d5722595a056cbddbca1247d9b1a20a7e0fc8d56413a0?placeholderIfAbsent=true&apiKey=a98241ab2d584afe817596fb423a2646"
              alt="Customers" loading="lazy">
          </span>
          <span class="nav-text">Customers</span>
        </a>

        <a href="offers" class="nav-link">
          <span class="nav-icon">
            <img
              src="https://cdn.builder.io/api/v1/image/assets/TEMP/ba76937fe489134f0c577be82a18baeadddda8f77194bbcb94734c6db29400c0?placeholderIfAbsent=true&apiKey=a98241ab2d584afe817596fb423a2646"
              alt="Offers" loading="lazy">
          </span>
          <span class="nav-text">Offers</span>
        </a>

        <a href="coupons" class="nav-link">
          <span class="nav-icon">
            <img
              src="https://cdn.builder.io/api/v1/image/assets/TEMP/cabe95d2f5fab42e35aad96d91245b122dd4d50ddfe8d1d2bceee5ea219442d8?placeholderIfAbsent=true&apiKey=a98241ab2d584afe817596fb423a2646"
              alt="Coupons" loading="lazy">
          </span>
          <span class="nav-text">Coupons</span>
        </a>

        <a href="#" class="nav-link">
          <span class="nav-icon">
            <img
              src="https://cdn.builder.io/api/v1/image/assets/TEMP/2897cc0ce7ace4dd1f7e6d2c1b779540e7fa6d14150e07ac6bd13caecdf99b1a?placeholderIfAbsent=true&apiKey=a98241ab2d584afe817596fb423a2646"
              alt="Reviews" loading="lazy">
          </span>
          <span class="nav-text">Reviews</span>
        </a>

        <a href="#" class="nav-link">
          <span class="nav-icon">
            <img
              src="https://cdn.builder.io/api/v1/image/assets/TEMP/5b4c30ca0a115c712594c2dce59791803bec209977f960ad8b2c1a3d2ecaac23?placeholderIfAbsent=true&apiKey=a98241ab2d584afe817596fb423a2646"
              alt="Settings" loading="lazy">
          </span>
          <span class="nav-text">Settings</span>
        </a>
      </div>
    </div>


    {{!-- Content Section --}}
    <div class="col-md-10">

      {{!-- Breadcrumps --}}
      <div class="row px-2 pt-2">
        <div class="col-10">
          <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
            <ol class="breadcrumb">
              <li class="breadcrumb-item"><a href="#" class="link-dark link-underline-opacity-0">Admin</a>
              </li>
              <li class="breadcrumb-item active text-dark" aria-current="page">Dashboard</li>
            </ol>
          </nav>
        </div>
        <div class="col-2">
          <button type="button" class="btn btn-outline-dark btn-sm"
            onclick="window.location.href='/admin/logout'">Logout<i class="bi bi-box-arrow-right ps-2"></i></button>

        </div>
      </div>

      <div class="containerbox m-0 p-4" style="width: 98%;">
        <div class="row">


          <h2 class="col-8">Sales Report</h2>
          <!-- Download Buttons -->
          <div class="col-4 d-flex justify-content-center">
            <button class="btn btn-outline-danger me-2" id="downloadPDF">Download PDF</button>
            <button class="btn btn-outline-success" id="downloadExcel">Download Excel</button>
          </div>
        </div>


        <!-- Filter -->
        <form id="filterForm" class="row g-3 mb-4 d-flex justify-content-start">
          <div class="col-md-3" hidden>
            <label class="form-label">Start Date</label>
            <input type="date" id="startDate" class="form-control">
          </div>
          <div class="col-md-3" hidden>
            <label class="form-label">End Date</label>
            <input type="date" id="endDate" class="form-control">
          </div>
          <div class="col-md-3">
            <label class="form-label">Filter by</label>
            <select id="filter" class="form-select">
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
              <option value="monthly">Monthly</option>
              <option value="yearly">Yearly</option>
              <option value="custom">Custom Date</option>
            </select>
          </div>
          <div class="col-md-3 d-flex align-items-end ">
            <button type="button" class="btn btn-primary w-100" id="generateReport">
              <span class="button-text">Generate Report</span>
              <div class="spinner-border spinner-border-sm d-none ms-2" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </button>
          </div>
        </form>


        <!-- Sales Table -->
        <div class="table-responsive mb-5">
          <table id="salesTable" class="table table-bordered table-striped text-center">
            <thead class="table-dark">
              <tr>
                <th>Product Name</th>
                <th>Sold</th>
                <th>Returns</th>
                <th>Offer Discounts</th>
                <th data-bs-toggle="tooltip" data-bs-placement="top"
                  title="This is the price of the total products sold after offer discount.">
                  Revenue (₹)
                </th>
              </tr>
            </thead>
            <tbody>
              {{#each orders}}
              <tr>
                <td>{{productName}} - {{variant}}ML</td>
                <td>{{soldCount}}</td>
                <td>{{returnedCount}}</td>
                <td>₹{{offerDiscounts}}</td>
                <td>₹{{revenue}}</td>
              </tr>
              {{/each}}
            </tbody>
          </table>
        </div>


        <!-- Summary Cards -->
        <div class="row g-3 mb-4">
          <div class="col-md-4">
            <div class="card text-white bg-success shadow-sm">
              <div class="card-body" id="overall-sales-count">Overall Sales Count: {{overallSalesCount}}</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card text-white bg-primary shadow-sm">
              <div class="card-body" id="overall-order-amount">Order Count: {{orderCount}}</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card text-white bg-dark shadow-sm">
              <div class="card-body" id="net-revenue">Net Revenue: ₹{{netRevenue}}</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card text-white bg-warning shadow-sm">
              <div class="card-body" id="discounts">Offer Discounts: ₹{{offerDiscounts}}</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card text-white bg-info shadow-sm">
              <div class="card-body" id="coupon-discounts">Coupon Discounts: ₹{{couponDiscounts}}</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card text-white bg-secondary shadow-sm">
              <div class="card-body" id="overall-discount">Overall Discount: ₹{{overallDiscount}}</div>
            </div>
          </div>

        </div>




      </div>







    </div>
  </div>

</section>





<script>
  const filterSelect = document.getElementById('filter');
  const startDateDiv = document.getElementById('startDate').parentElement;
  const endDateDiv = document.getElementById('endDate').parentElement;

  filterSelect.addEventListener('change', function () {
    const isCustom = this.value === 'custom';
    startDateDiv.hidden = !isCustom;
    endDateDiv.hidden = !isCustom;
  });
</script>



<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.24/jspdf.plugin.autotable.min.js"></script>






<script>

  $(document).ready(function () {


    const salesTable = $('#salesTable').DataTable({
      responsive: true,
      order: [[1, 'desc']]
    });

    // Add Bootstrap classes to existing DataTables elements
    const wrapper = $('.dataTables_wrapper');

    // --- Top Controls ---
    const topControls = $('<div class="d-flex justify-content-between align-items-center mb-1 flex-wrap w-100"></div>');
    topControls.append(wrapper.find('.dataTables_length'));
    topControls.append(wrapper.find('.dataTables_filter'));
    wrapper.prepend(topControls);

    // --- Bottom Controls (Info & Pagination) ---
    const bottomControls = $('<div class="d-flex justify-content-between align-items-center mt-2 flex-wrap w-100"></div>');
    bottomControls.append(wrapper.find('.dataTables_info'));
    bottomControls.append(wrapper.find('.dataTables_paginate'));
    wrapper.append(bottomControls);



    $('#filter').on('change', function () {
      const dateInputs = $('.date-inputs');
      dateInputs.toggleClass('d-none', $(this).val() !== 'custom');
    });



    $('#generateReport').on('click', async function () {
      const button = $(this);
      const buttonText = button.find('.button-text');
      const spinner = button.find('.spinner-border');
      const filter = $('#filter').val();
      const startDate = $('#startDate').val();
      const endDate = $('#endDate').val();





      if (filter === 'custom') {
        if (!startDate) {
          Swal.fire({
            icon: 'warning',
            title: 'Missing Date!',
            text: 'Please enter the start date.',
            confirmButtonColor: '#3085d6',
            confirmButtonText: 'OK'
          });
          return;
        }

        if (!endDate) {
          Swal.fire({
            icon: 'warning',
            title: 'Missing Date!',
            text: 'Please enter the end date.',
            confirmButtonColor: '#3085d6',
            confirmButtonText: 'OK'
          });
          return;
        }

        if (new Date(startDate) > new Date(endDate)) {
          Swal.fire({
            icon: 'warning',
            title: 'Missing Date!',
            text: 'Start date must be before end date.',
            confirmButtonColor: '#3085d6',
            confirmButtonText: 'OK'
          });
          return;
        }

      }

      buttonText.addClass('d-none');
      spinner.removeClass('d-none');
      button.prop('disabled', true);

      try {
        const response = await $.ajax({
          url: '/admin/sales-report-data',
          method: 'GET',
          data: { filter, startDate, endDate }
        });

        salesTable.clear();
        response.result.forEach(item => {
          salesTable.row.add([
            `${item.productName} ${item.size}`,
            item.soldCount,
            item.returnedCount,
            `₹${item.offerDiscounts.toFixed(2)}`,
            `₹${item.revenue.toFixed(2)}`
          ]);
        });
        salesTable.draw();

        $('#discounts').text(`Offer Discounts: ₹${response.totalOfferDiscounts?.toFixed(2) || 0}`);
        $('#coupon-discounts').text(`Coupon Discounts: ₹${response.totalCouponDiscount?.toFixed(2) || 0}`);
        $('#overall-sales-count').text(`Overall Sales Count: ${response.totalSold || 0}`);
        $('#overall-order-amount').text(`Order Count: ${((response.totalSold || 0) + (response.totalReturns || 0))}`);
        $('#overall-discount').text(`Overall Discount: ₹${response.overallDiscount?.toFixed(2) || 0}`);
        $('#net-revenue').text(`Net Revenue: ₹${response.netRevenue?.toFixed(2) || 0}`);

      } catch (error) {
        console.error('Error fetching report:', error);
        alert('Failed to generate report. Please try again.');
      } finally {
        buttonText.removeClass('d-none');
        spinner.addClass('d-none');
        button.prop('disabled', false);
      }
    });

    $('#downloadExcel, #downloadPDF').on('click', function () {
      const format = $(this).attr('id') === 'downloadExcel' ? 'excel' : 'pdf';
      const filter = $('#filter').val();
      const startDate = $('#startDate').val();
      const endDate = $('#endDate').val();

      const params = new URLSearchParams({
        format,
        filter,
        ...(startDate && { startDate }),
        ...(endDate && { endDate })
      });

      window.location.href = `/admin/sales-report-download?${params.toString()}`;
    });
  });

  document.addEventListener("DOMContentLoaded", function () {
    const tooltips = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltips.map(el => new bootstrap.Tooltip(el));
  });


</script>